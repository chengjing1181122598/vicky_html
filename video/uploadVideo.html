<!DOCTYPE html>
<html>

	<head>
		<meta charset="UTF-8">
		<title>上传视频</title>
		<link rel="stylesheet" href="../css/other/bootstrap.min.css" />
		<link rel="stylesheet" href="../css/ourself/common/common.css" />
		<link rel="stylesheet" href="../css/ourself/user/user.css" />

		<link rel="stylesheet" href="../css/other/default.css" />
		<link rel="stylesheet" media="all" href="../css/other/fileinput.css" />

		<script type="text/javascript" src="../js/other/jquery-1.11.2.min.js"></script>
		<script type="text/javascript" src="../js/other/bootstrap.min.js"></script>
		<script type="text/javascript" src="../js/ourself/common/common.js"></script>

		<script type="text/javascript" src="../js/ourself/common/topDom.js"></script>
		<script type="text/javascript" src="../js/ourself/user/mustLogin.js"></script>

		<script type="text/javascript" src="../js/other/fileinput.js"></script>
		<script type="text/javascript" src="../js/other/zh.js"></script>
	</head>
	<style type="text/css">
		.uploadBtn {
			width: 135px;
			height: 135px;
			line-height: 135px;
			padding: 0px;
		}
	</style>

	<body>
		<div class="mySolidBorder">
			<div>
				<form class="formCenter" enctype="multipart/form-data" id="form" onsubmit="return false;">
					<div class="myCenter">
						<h2>视频投稿</h2>
						<span class="redTip"></span>
					</div>
					<div>
						<select name="moduleId" class="form-control" style="width: 20%;display: inline-block;" data-toggle="tooltip" data-placement="left" title="视频所属分类">
							<option value="001">动画</option>
							<option value="002">番剧</option>
							<option value="003">音乐</option>
							<option value="004">舞蹈</option>
							<option value="005">游戏</option>
							<option value="006">科技</option>
							<option value="007">生活</option>
							<option value="008">鬼畜</option>
							<option value="009">时尚</option>
							<option value="010">广告</option>
							<option value="011">娱乐</option>
							<option value="012">影视</option>
						</select>
						<input required="required" type="text" class="form-control" name="videoTitle" placeholder="请输入视频标题" style="display: inline-block;width: 79%;" data-toggle="tooltip" data-placement="right" title="标题长度30个字以内" />
					</div>
					<br />
					<div class="form-group">
						<textarea name="videoExplain" required="required" class="form-control" rows="3" placeholder="请输入视频内容" data-toggle="tooltip" data-placement="top" title="视频内容255个字以内"></textarea>
					</div>
					<div>
						<div data-toggle="tooltip" data-placement="top" title="先选择封面图片，再选择mp4文件">
							<input required="required" id="files" name="files" type="file" accept=".png,.jpg,.jpeg,.gif" multiple="multiple" />
						</div>
						<br />
						<div style="height: 135px;display: none;" id="yulanDiv">
							<div style="float: left;">
								<span style="display: inline-block;font-weight: bold;font-size: 22px;">封<br />面<br />预<br />览</span>
								<img id="yulan" style="vertical-align: top;" width="240" height="135" />
							</div>
							<div style="float: right;height: 135px;" id="haha">
								<!--<a href="#" tabindex="500" title="上传选中文件" class="btn btn-default fileinput-upload fileinput-upload-button">
									<i class="glyphicon glyphicon-upload">::before</i>
									<span class="hidden-xs">上传</span>
								</a>-->
								<!--<button id="loginBtn" type="" class="btn btn-primary fileinput-upload" style="width:135px;height: 135px;">确定投稿</button>-->
							</div>
						</div>
					</div>
					<button hidden="hidden" type="submit" id="formSubmit"></button>
				</form>
			</div>
		</div>

		<div class="modal fade" id="tip" aria-hidden="true" data-show="false">
			<div class="modal-dialog">
				<div class="modal-content">
					<div class="modal-header">
						<h4 class="modal-title">提示</h4>
					</div>
					<div class="modal-body">
						投稿成功，正在等待审核，请留意通知消息！
					</div>
					<div class="modal-footer">
						<button type="button" class="btn btn-primary" data-dismiss="modal">关闭</button>
					</div>
				</div>
				<!-- /.modal-content -->
			</div>
			<!-- /.modal-dialog -->
		</div>
		<!-- /.modal -->
	</body>
	<script type="text/javascript">
		$("#tip").on("hide.bs.modal", function() {
			window.location.reload();
		});

		var uploadBtn;
		var fileNumber = 0;
		$(function() {
			$("[data-toggle='tooltip']").tooltip();
			$("#files").prev().text("选择封面");
			uploadBtn = $('[title="上传选中文件"]');
			uploadBtn.hide();
		});

		$('#files').fileinput({
			showPreview: false,
			uploadAsync: false,
			language: 'zh',
			uploadUrl: data_path + '/videoCheck/save',
			//			showUpload: false,
			maxFileCount: 2
		});

		$("#files").change(function() {
			fileNumber++;
			if(fileNumber === 2) {

				var doms = $("form").find("input,textarea").toArray();
				for(var i = 0; i < doms.length; i++) {
					if(!doms[0].checkValidity()) {
						$("#formSubmit").trigger("click");
						return;
					}
				}
				uploadBtn.show();
				$("#haha").append(uploadBtn);
				$(uploadBtn).addClass("uploadBtn");
				return;
			}
			var objUrl = getObjectURL(this.files[0]);
			console.log("objUrl = " + objUrl);
			if(objUrl) {
				$("#yulan").attr("src", objUrl);
				$("#yulanDiv").show();
				$('#files').attr("accept", ".mp4");
				$("#files").prev().text("选择视频");
			}
		});
		//建立一個可存取到該file的url
		function getObjectURL(file) {
			var url = null;
			if(window.createObjectURL != undefined) { // basic
				url = window.createObjectURL(file);
			} else if(window.URL != undefined) { // mozilla(firefox)
				url = window.URL.createObjectURL(file);
			} else if(window.webkitURL != undefined) { // webkit or chrome
				url = window.webkitURL.createObjectURL(file);
			}
			return url;
		}

		//		$('#files').fileinput({
		//			showPreview: false,
		//			language: 'zh',
		//			uploadUrl: data_path + '/videoCheck/save',
		//			//			showUpload: false,
		//			allowedFileExtensions: ['jpg', 'png', 'gif', 'jpeg'],
		//		});

		function appendParam(f) {
			f.append("moduleId", $("select[name='moduleId']").val());
			f.append("videoTitle", $("input[name='videoTitle']").val());
			f.append("videoExplain", $("textarea[name='videoExplain']").val());
		}

		$("#files").on("fileuploaded", function(event, data, previewId, index) {
			console.info(data);
			data = data.response;
			if(data.status === successStatus) {
				console.info(data);
				$("#tip").modal("show");
			} else {
				$(".redTip").text(data.message.message);
			}
		});

		$('#files').on('filecleared', function(event, data, previewId, index) {
			$('#files').attr("accept", ".png,.jpg,.jpeg,.gif");
			$("#yulanDiv").hide();
			uploadBtn.hide();
			fileNumber = 0;
			$("#files").prev().text("选择封面");
		});
	</script>

</html>
<!DOCTYPE html>
<html>

	<head>
		<meta charset="UTF-8">
		<title></title>
		<link rel="stylesheet" href="../css/other/bootstrap.min.css" />
		<link rel="stylesheet" href="../css/ourself/common/common.css" />
		<link rel="stylesheet" href="../css/ourself/user/user.css" />

		<script type="text/javascript" src="../js/other/jquery-1.11.2.min.js"></script>
		<script type="text/javascript" src="../js/other/bootstrap.min.js"></script>
		<script type="text/javascript" src="../js/ourself/common/common.js"></script>
		<script type="text/javascript" src="../js/other/jquery.lazyload.js"></script>

		<script type="text/javascript" src="../js/ourself/common/topBottom.js"></script>
	</head>
	<style>
		.touXiang {
			width: 68px;
			height: 68px;
			border-radius: 34px;
			margin-right: 10px;
		}
		
		.signature {
			display: -webkit-box;
			font-size: 14px;
			overflow: hidden;
			text-overflow: ellipsis;
			-webkit-line-clamp: 3;
			-webkit-box-orient: vertical;
			width: 220px;
			-webkit-box-lines: ;
		}
		
		.collect {
			display: inline-block;
			width: 60px;
			height: 60px;
			line-height: 60px;
			margin-right: 10px;
		}
		
		.uncollect {
			background: url(../img/common/anim-fav.png) -8px -10px;
		}
		
		.collected {
			background: url(../img/common/anim-fav.png) -8px -90px;
		}
		
		#collectBtn {
			color: black;
		}
		
		#collectBtn:hover {
			color: rgb(0, 161, 214);
		}
		
		.videoExplain {
			display: -webkit-box;
			font-size: 14px;
			overflow: hidden;
			text-overflow: ellipsis;
			-webkit-line-clamp: 3;
			-webkit-box-orient: vertical;
			-webkit-box-lines: ;
		}
	</style>

	<body>
		<div class="mainContainer">
			<div class="allWidth mainContent">
				<br />
				<div style="min-height: 150px;max-height: 200px;">
					<div class="floatLeft" style="width: 500px;">
						<span id="videoTitle" style="font-size: 20px;">[排行向]老司机最喜欢的劳模排行</span>
						<hr />
						<span id="videoExplain" class="videoExplain">720P 这是正规学术研究!!请老司机不要开车W曲+图包: http://pan.baidu.com/s/1bp7ScI7</span>
					</div>

					<div class="floatRight" style="">
						<div style="display: inline-block;vertical-align:top">
							<img class="touXiang" src="../img/common/cover.jpg" />
						</div>
						<div style="display: inline-block;width: 220px;">
							<a id="authorUsername" href="javascript:void(0);" style="text-decoration: none;color: rgb(0, 161, 214);font-size: 15px;">疾风酱</a>
							<br />
							<span class="signature">
							44%的乳控+30%的女儿+6%的萝莉+15%作死+5%伪娘,组成疾风酱44%的乳控+30%的女儿+6%的萝莉+15%作死+5%伪娘,组成疾风酱
						</span>
							<br />
							<div>
								<span style="font-size: 12px;color: gray;">投稿：246</span>
								<button id="followBtn" onclick="followOrUnfollow();" class="btn btn-primary" style="width: 100px;height:24px;margin-left: 10px;padding: 0px;background-color: #00b5e5;border:none;">关注</button>
							</div>
						</div>
					</div>
				</div>
				<hr />
				<div style="width: 640px;">
					<video height="360" controls="controls" poster="">

					</video>
				</div>
				<br />
				<div>
					<div style="line-height: 60px;height: 60px;">
						<a id="collectBtn" href="javascript:void(0);" onclick="collectOrUncollect();">
							<div class="collect floatLeft"></div>
							<div class="floatLeft" style="font-size: 20px;">&nbsp;</div>
						</a>
					</div>
				</div>
			</div>
		</div>
	</body>
	<script type="text/javascript">
		$("img").lazyload({
			effect: "fadeIn"
		});

		var videoId = "";
		var videoEntity = "";
		var collectStatus = "";
		var followStatus = "";
		var collectContent = $(".collect").next();
		var followContent = $("#followBtn");
		$(function() {
			videoId = getUrlParam("videoId");
			loadVideo();
			loadCollectStatus();
			loadFollowStatus();

			collectContent.hover(function() {
				if(collectStatus === "yes") {
					collectContent.text("取消收藏");
				}
			});
			collectContent.mouseleave(function() {
				changeCollect();
			});

			followContent.hover(function() {
				if(followStatus === "yes") {
					followContent.text("取消关注");
				}
			});
			followContent.mouseleave(function() {
				changeFollow();
			});
		});

		function loadFollowStatus() {
			$.ajax({
				url: data_path + "/collectUser/isCollected",
				dataType: "json",
				data: {
					videoId: videoId,
				},
				success: function(data) {
					if(data.message.message === "yes") {
						followStatus = "yes";
					} else {
						followStatus = "no";
					}
					changeFollow();
				},
				xhrFields: {
					withCredentials: true
				},
				crossDomain: true
			});
		}

		function changeFollow() {
			if(followStatus === "yes") {
				followContent.text("已关注");
				followContent.css("background-color", "red");
			} else {
				followContent.text("关注");
				followContent.css("background-color", "#00b5e5");
			}
		}

		function followOrUnfollow() {
			if(user === undefined) {
				saveLastPage();
				window.location.href = html_path + "/user/login.html";
			} else {
				var url = "";
				if(followStatus === "yes") {
					url = data_path + "/collectUser/uncollect";
				} else {
					url = data_path + "/collectUser/collect";
				}
				$.ajax({
					url: url,
					dataType: "json",
					data: {
						collectedUsername: videoEntity.username,
					},
					success: function(data) {
						loadFollowStatus();
					},
					xhrFields: {
						withCredentials: true
					},
					crossDomain: true
				});
			}
		}

		function loadCollectStatus() {
			$.ajax({
				url: data_path + "/collectVideo/isCollected",
				dataType: "json",
				data: {
					videoId: videoId,
				},
				success: function(data) {
					if(data.message.message === "yes") {
						collectStatus = "yes";
					} else {
						collectStatus = "no";
					}
					changeCollect();
				},
				xhrFields: {
					withCredentials: true
				},
				crossDomain: true
			});
		}

		function changeCollect() {
			if(collectStatus === "yes") {
				$(".collect").removeClass("uncollect");
				$(".collect").addClass("collected");
				collectContent.text("已收藏");
			} else {
				$(".collect").removeClass("collected");
				$(".collect").addClass("uncollect");
				collectContent.text("收藏");
			}
		}

		function collectOrUncollect() {
			if(user === undefined) {
				saveLastPage();
				window.location.href = html_path + "/user/login.html";
			} else {
				var url = "";
				if(collectStatus === "yes") {
					url = data_path + "/collectVideo/uncollect";
				} else {
					url = data_path + "/collectVideo/collect";
				}
				$.ajax({
					url: url,
					dataType: "json",
					data: {
						videoId: videoId,
					},
					success: function(data) {
						loadCollectStatus();
					},
					xhrFields: {
						withCredentials: true
					},
					crossDomain: true
				});
			}
		}

		function loadAuthor() {
			$.ajax({
				url: data_path + "/user/getById",
				dataType: "json",
				data: {
					username: videoEntity.username,
				},
				success: function(data) {
					if(data.status === successStatus) {
						var user = data.message.entity;
						$(".touXiang").attr("src", user.relativePath);
						$(".signature").text(user.signature);
						$(".signature").attr("title", user.signature);
						$("#authorUsername").text(user.username);
					}
				},
				xhrFields: {
					withCredentials: true
				},
				crossDomain: true
			});
		}

		function loadVideo() {
			$.ajax({
				url: data_path + "/video/getById",
				dataType: "json",
				data: {
					primaryKey: videoId,
				},
				success: function(data) {
					if(data.status === successStatus) {
						videoEntity = data.message.entity;
						loadAuthor();

						$("video").attr("src", videoEntity.relativePath);
						$("video").attr("poster", videoEntity.coverRelativePath);
						window.document.title = videoEntity.videoTitle;
						$("#videoTitle").text(videoEntity.videoTitle);
						$("#videoExplain").text(videoEntity.videoExplain);
					}
				},
				xhrFields: {
					withCredentials: true
				},
				crossDomain: true
			});
		}
	</script>

</html>